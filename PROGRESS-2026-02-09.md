# Progress Report - February 9, 2026

## Badge Size Fix - COMPLETED ✓

### Issue
- Product badges on staging were 60px wide, while live UK site had 50px badges
- This made staging badges appear 20% larger than intended
- User reported: "staging badge size in both collection and single product pages are bigger than live"

### Investigation
1. Measured badge dimensions on both sites:
   - Staging: 60px × 91.33px
   - Live UK: 50px × 76.11px
2. Located CSS rule in `/src/pages/products/[slug].astro` line 668

### Solution
1. **Updated CSS** (`/src/pages/products/[slug].astro:668`):
   ```css
   /* Before */
   .product-badges .badge {
     width: 60px;
     height: auto;
   }

   /* After */
   .product-badges .badge {
     width: 50px;
     height: auto;
   }
   ```

2. **Rebuilt Astro site**:
   - Generated 156 pages successfully
   - New CSS file: `_slug_.DpmbDEMY.css` (replaced `_slug_.BHI_LIeC.css`)

3. **Deployed to Cloudflare Pages**:
   - Deployment URL: https://6c35646a.hercules-uk-staging-e9z.pages.dev
   - Verified product pages working (HTTP 200)
   - Confirmed badge width: 50px

4. **Updated Edge Router**:
   - Redeployed edge router worker to pick up new Astro deployment
   - New Version ID: bc3c6aca-ae29-4628-8428-19695dbae1a1

5. **Purged Cloudflare Cache**:
   - Full cache purge for hercules-merchandise.co.uk zone
   - Verified staging now loads new CSS

### Verification
- ✓ Staging CSS file: `_slug_.DpmbDEMY.css`
- ✓ Badge width: 50px (matches live UK site)
- ✓ Applies to both collection and single product pages
- ✓ Expected rendered dimensions: 50px × 76px

### Files Modified
- `/home/kamindu/hercules-headless-uk/src/pages/products/[slug].astro` (line 668)

### Deployments
- Astro Pages: https://6c35646a.hercules-uk-staging-e9z.pages.dev
- Edge Router: Version bc3c6aca-ae29-4628-8428-19695dbae1a1
- Staging Site: https://staging.hercules-merchandise.co.uk

---

## Contact Form File Upload Button Styling - COMPLETED ✓

### Issue
- File upload buttons in Quick Delivery and Custom Quote contact forms were using default browser styling
- Didn't match the design system (Jost font, border-radius, colors)
- ContactFormPopup had proper custom styling, but other two forms didn't

### Investigation
1. Checked three contact form popups:
   - `ContactFormPopup.tsx` - Had proper custom styled file upload button ✓
   - `ExpressDeliveryPopup.tsx` (Quick Delivery) - Using default browser input ✗
   - `QuantityRequestPopup.tsx` (Custom Quote) - Using default browser input ✗

2. Identified proper pattern from ContactFormPopup:
   - Hide default file input with `display: none`
   - Use `<label htmlFor="input-id">` to trigger hidden input
   - Style the label as a button with Jost font, rounded corners, hover effects

### Solution

**ExpressDeliveryPopup.tsx:**
1. Updated HTML structure (lines 408-437):
   - Added `id="urgent-files"` to file input
   - Added `className="urgent-file-input"` (hidden)
   - Created styled `<label htmlFor="urgent-files">` with upload icon
   - Added file hint text
   - Updated file list display

2. Added CSS styling (lines 604-658):
   ```css
   .urgent-file-input { display: none; }
   .urgent-file-label {
     /* Custom button styling with Jost font, dashed border, hover effects */
   }
   .urgent-file-list, .urgent-file-item {
     /* Styled file list display */
   }
   ```

**QuantityRequestPopup.tsx:**
1. Updated HTML structure (lines 302-333):
   - Added `id="quantity-files"` to file input
   - Added `className="kd-file-input-hidden"` (hidden)
   - Created styled `<label htmlFor="quantity-files">` with upload icon
   - Added file hint text
   - Wrapped in `.kd-file-upload-wrapper`

2. Updated CSS styling (lines 550-605):
   ```css
   .kd-file-input-hidden { display: none; }
   .kd-file-upload-button {
     /* Custom button styling matching design system */
   }
   .kd-selected-files, .kd-file-item {
     /* Enhanced file list display */
   }
   ```

### Design System Match
All file upload buttons now feature:
- Jost font family (14px, weight 400/500)
- Dashed border (#DCDCDC)
- Border-radius: 10px
- Background: #f5f5f5 (hover: #e8e8e8)
- Color: #253461 (hover: #469ADC)
- Upload icon (SVG)
- Smooth transitions (0.2s)

### Files Modified
- `/home/kamindu/hercules-headless-uk/src/components/ExpressDeliveryPopup.tsx`
- `/home/kamindu/hercules-headless-uk/src/components/QuantityRequestPopup.tsx`

---

## Cart Sync Fix - COMPLETED ✓

### Issue
- Cart count inconsistent between Astro header and WordPress
- When users add items on WordPress pages, Astro header shows old count
- When returning from WordPress to Astro pages, cart count doesn't update
- Cart data stored in localStorage but not syncing with WordPress server session

### Root Cause
1. UserSession component only reads from localStorage (`hercules_cart`)
2. WordPress updates server-side cart session
3. No automatic sync mechanism when navigating between Astro/WordPress
4. Visibility change handler only read localStorage, didn't fetch from server

### Solution

**Updated `/src/components/UserSession.tsx`:**

1. **Enhanced visibility change handler** (lines 154-177):
   - Now fetches cart from WordPress API when tab becomes visible
   - Previously only read from localStorage
   - Syncs cart after user returns from WordPress pages

2. **Added navigation sync** (lines 179-184):
   - Listens for `pageshow` event (back/forward navigation)
   - Syncs cart when page loaded from bfcache
   - Handles browser back/forward button

3. **Added periodic sync** (lines 197-201):
   - Automatic cart sync every 30 seconds
   - Only for cart icon types (`cart` and `cart-count`)
   - Prevents long-term drift between Astro and WordPress

4. **Smart sync function** (lines 159-177):
   ```typescript
   const syncCartFromServer = async () => {
     // Fetch from WordPress API
     const response = await fetch('/wp-json/hercules/v1/session');
     const data = await response.json();

     // Only update if cart changed (avoid unnecessary re-renders)
     if (currentCart.count !== data.cart.count) {
       cartStore.set(data.cart);
     }
   };
   ```

### Cart Sync Triggers
Cart now syncs automatically in these scenarios:
1. ✓ Initial page load (if localStorage empty)
2. ✓ Tab becomes visible (user returns from WordPress)
3. ✓ Back/forward navigation (bfcache restore)
4. ✓ Every 30 seconds (periodic sync)
5. ✓ Cart changes in localStorage (cross-tab sync)

### Technical Details
- Uses WordPress REST API: `/wp-json/hercules/v1/session`
- Includes credentials for cookie-based session
- Only updates if cart count or items changed (performance optimization)
- Maintains existing localStorage cache for fast reads

### Files Modified
- `/home/kamindu/hercules-headless-uk/src/components/UserSession.tsx`

### Deployments
- Astro Pages: https://5f4478b4.hercules-uk-staging-e9z.pages.dev
- Edge Router: Version b6df0431-57d2-4f3f-972d-a53c22172a8f
- Staging Site: https://staging.hercules-merchandise.co.uk

---

## Add to Cart CORS Fix - COMPLETED ✓

### Issue
- Products not adding to cart on UK staging site
- Add to cart button loading but cart not updating
- No error messages visible to user

### Root Cause
- WordPress mu-plugin `hercules-cart-api.php` had CORS whitelist
- Only included German domains (hercules-merchandise.de)
- UK domains (hercules-merchandise.co.uk) were blocked
- Browser blocked POST requests to `/wp-json/hercules/v1/cart/add`

### Solution

**Updated `/wp-content/mu-plugins/hercules-cart-api.php` on UK staging WordPress:**

Added UK domains to CORS whitelist:
```php
$allowed_origins = [
    // German domains (existing)
    'https://hercules-merchandise.de',
    'https://staging.hercules-merchandise.de',
    // UK domains (ADDED)
    'https://hercules-merchandise.co.uk',
    'https://staging.hercules-merchandise.co.uk',
    'https://hercules-uk-staging-e9z.pages.dev',
    // Local development
    'http://localhost:4321',
];
```

### Technical Details
- Endpoint: `/wp-json/hercules/v1/cart/add`
- Method: POST with credentials
- CORS headers: Access-Control-Allow-Origin, Access-Control-Allow-Credentials
- Now accepts requests from UK Astro frontend

### Testing
Products should now add to cart successfully on:
- https://staging.hercules-merchandise.co.uk
- All product configurator forms
- Both "Create Quote" and "Add to Cart" buttons

---

## Cart Persistence Fix - COMPLETED ✓

### Issue
- Products adding to cart initially (visible in localStorage)
- But cart items disappearing on page refresh
- Cart count not showing in header after refresh
- Items not persisting to WordPress/WooCommerce session

### Root Cause Analysis
1. **Session API CORS Whitelist** - Only included German domains
   - `hercules-session-api.php` had two CORS whitelists (lines 42-50, 314-322)
   - UK domains not included, blocking session sync requests
   - UserSession.tsx calls `/wp-json/hercules/v1/session` to sync cart
   - CORS errors prevented cart data from being fetched from WordPress

2. **WooCommerce Session Cookie Not Set** - Session initialization incomplete
   - Cart API called `WC()->session->save_data()` but didn't ensure cookie was set
   - For new sessions (first add to cart), session cookie wasn't being created
   - Without session cookie, subsequent requests couldn't retrieve cart data

### Solution

**Updated `hercules-session-api.php` CORS whitelists:**

Added UK domains to both CORS arrays:
```php
// First CORS array (hercules_set_headers function - line 42)
$allowed_origins = [
    // ... German domains ...
    'https://hercules-merchandise.co.uk',         // ADDED
    'https://staging.hercules-merchandise.co.uk', // ADDED
    'https://hercules-uk-staging-e9z.pages.dev',  // ADDED
    'http://localhost:4321',
];

// Second CORS array (rest_api_init filter - line 314)
$allowed_origins = [
    // ... German domains ...
    'https://hercules-merchandise.co.uk',         // ADDED
    'https://staging.hercules-merchandise.co.uk', // ADDED
    'https://hercules-uk-staging-e9z.pages.dev',  // ADDED
    'http://localhost:4321',
];
```

**Updated `hercules-cart-api.php` session initialization:**

Added explicit session cookie setting:
```php
// After line 103 (get_cart_from_session):
// Ensure session is properly initialized with a customer ID
if (!WC()->session->has_session()) {
    WC()->session->set_customer_session_cookie(true);
}

// After line 150 (save_data):
// Explicitly ensure session cookie is set
WC()->session->set_customer_session_cookie(true);
```

### How It Works Now

1. **Add to Cart Flow:**
   - User adds product via configurator
   - POST to `/wp-json/hercules/v1/cart/add`
   - Cart API initializes WooCommerce session
   - Checks if session exists, creates one if needed
   - Adds product to cart
   - Saves session data to database
   - **Explicitly sets session cookie** (`wp_woocommerce_session_*`)
   - Returns cart data with Set-Cookie headers
   - Edge router forwards cookies to browser
   - ProductConfigurator.tsx updates localStorage

2. **Page Refresh / Navigation:**
   - UserSession.tsx detects visibility change / navigation
   - Fetches from `/wp-json/hercules/v1/session`
   - **Now accepts UK origin** (CORS fixed)
   - Browser sends WooCommerce session cookie
   - WordPress reads session from database
   - Returns cart data
   - Updates Astro header cart count

3. **Cross-Tab Sync:**
   - Changes in localStorage trigger sync across tabs
   - Periodic 30-second sync fetches from WordPress
   - Session cookie maintains cart state server-side

### Technical Details

**WooCommerce Session Cookie:**
- Name: `wp_woocommerce_session_<hash>`
- Contains: `<customer_id>|<expiration>|<hash>`
- Set by: `WC_Session_Handler::set_customer_session_cookie()`
- Domain: Rewritten by edge router to match staging domain
- HttpOnly: No (needs JS access for edge router)

**Edge Router Cookie Forwarding:**
- Request: Copies `Cookie` header to `X-Edge-Cookies`
- Response: Rewrites `Set-Cookie` domains to match staging domain
- WordPress mu-plugins restore cookies from `X-Edge-Cookies` header

### Files Modified
- `staging.hercules-merchandise.co.uk/wp-content/mu-plugins/hercules-session-api.php` (CORS whitelist)
- `staging.hercules-merchandise.co.uk/wp-content/mu-plugins/hercules-cart-api.php` (session initialization)

### Verification Steps
1. ✓ Session API returns HTTP 200 for UK origin
2. ✓ WordPress no PHP errors after changes
3. Next: Test add to cart and verify persistence on refresh
