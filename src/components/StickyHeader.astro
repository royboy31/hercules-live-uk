---
// Sticky Header - Shows on scroll (replaces main header when scrolled)
// Exact match to WordPress Elementor CSS from post-196.css
// Menu data fetched from shared cache (single API call for all components)
import ProductSearch from './ProductSearch.tsx';
import UserSession from './UserSession.tsx';
import WishlistCount from './WishlistCount.tsx';
import ContactFormPopup from './ContactFormPopup.tsx';
import { getMenuData } from '../data/menu-data';

// Get menu data from shared cache (fetched once per build)
const menuData = await getMenuData();
const { sportarten, produkte, themen } = menuData;
---

<header class="sticky-header" id="sticky-header">
  <div class="sticky-header-container">
    <!-- Section 190f56f - 25% width - Menu -->
    <div class="sticky-section sticky-menu-section">
      <div class="sticky-menu-wrapper">
        <button class="elementor-menu-toggle" id="sticky-menu-toggle" aria-label="MenÃ¼ Umschalter" aria-expanded="false">
          <svg class="menu-icon-open" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg">
            <path d="M104 333H896C929 333 958 304 958 271S929 208 896 208H104C71 208 42 237 42 271S71 333 104 333ZM104 583H896C929 583 958 554 958 521S929 458 896 458H104C71 458 42 487 42 521S71 583 104 583ZM104 833H896C929 833 958 804 958 771S929 708 896 708H104C71 708 42 737 42 771S71 833 104 833Z" fill="currentColor"/>
          </svg>
          <svg class="menu-icon-close" viewBox="0 0 1000 1000" xmlns="http://www.w3.org/2000/svg">
            <path d="M742 167L500 408 258 167C246 154 233 150 217 150 196 150 179 158 167 167 154 179 150 196 150 212 150 229 154 242 171 254L408 500 167 742C138 771 138 800 167 829 196 858 225 858 254 829L496 587 738 829C750 842 767 846 783 846 800 846 817 842 829 829 842 817 846 804 846 783 846 767 842 750 829 737L588 500 833 258C863 229 863 200 833 171 804 137 775 137 742 167Z" fill="currentColor"/>
          </svg>
        </button>
        <button class="all-categories-text" id="all-categories-toggle">
          ALLE KATEGORIEN
          <svg class="category-triangle" width="10" height="6" viewBox="0 0 10 6" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1L5 5L9 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>

        <!-- Dropdown Navigation -->
        <nav class="sticky-dropdown-nav" id="sticky-dropdown-nav" aria-hidden="true">
          <!-- Logo Header - full width with divider -->
          <div class="dropdown-logo-header">
            <img
              src="/images/hercules-logo-original1.webp"
              alt="Hercules Merchandise"
              class="dropdown-logo"
              width="176"
              height="78"
            />
          </div>

          <!-- Content area with two columns -->
          <div class="dropdown-content">
            <!-- Left Column: Main Menu -->
            <div class="dropdown-left-column">
              <ul class="sticky-nav-list">
                <li class="sticky-nav-item has-submenu" data-submenu="sportarten">
                  <button class="sticky-nav-link" aria-expanded="false">
                    Sportarten
                    <svg class="submenu-arrow" viewBox="0 0 256 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z" fill="currentColor"/></svg>
                  </button>
                </li>
                <li class="sticky-nav-item has-submenu" data-submenu="produkte">
                  <button class="sticky-nav-link" aria-expanded="false">
                    Produkte
                    <svg class="submenu-arrow" viewBox="0 0 256 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z" fill="currentColor"/></svg>
                  </button>
                </li>
                <li class="sticky-nav-item has-submenu" data-submenu="themen">
                  <button class="sticky-nav-link" aria-expanded="false">
                    Themen
                    <svg class="submenu-arrow" viewBox="0 0 256 512" xmlns="http://www.w3.org/2000/svg"><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z" fill="currentColor"/></svg>
                  </button>
                </li>
              </ul>
            </div>

            <!-- Right Column: Submenu Title + Items -->
            <div class="dropdown-right-column">
              <div class="submenu-title-wrapper">
                <span class="submenu-title">SPORTARTEN</span>
              </div>
              <div class="dropdown-submenu-container">
              <ul class="sticky-submenu" id="submenu-sportarten">
              {sportarten.map((item) => (
                <li>
                  <a href={item.href}>
                    {item.icon_url && <img src={item.icon_url} alt={`${item.label} Kategorie Icon`} width="36" height="36" loading="lazy" />}
                    <span>{item.label}</span>
                  </a>
                </li>
              ))}
            </ul>
            <ul class="sticky-submenu" id="submenu-produkte">
              {produkte.map((item) => (
                <li>
                  <a href={item.href}>
                    {item.icon_url && <img src={item.icon_url} alt={`${item.label} Kategorie Icon`} width="36" height="36" loading="lazy" />}
                    <span>{item.label}</span>
                  </a>
                </li>
              ))}
            </ul>
            <ul class="sticky-submenu" id="submenu-themen">
              {themen.map((item) => (
                <li>
                  <a href={item.href}>
                    {item.icon_url && <img src={item.icon_url} alt={`${item.label} Kollektion Icon`} width="36" height="36" loading="lazy" />}
                    <span>{item.label}</span>
                  </a>
                </li>
              ))}
            </ul>
              </div>
            </div>
          </div>
        </nav>
      </div>
    </div>

    <!-- Section 234bc1b - 50% width - Search -->
    <div class="sticky-section sticky-search-section">
      <ProductSearch client:idle placeholder="Produkte suchen..." />
    </div>

    <!-- Section df3bc94 - 25% width - Icons -->
    <!-- client:idle breaks critical request chain - session fetch deferred until browser idle -->
    <div class="sticky-section sticky-icons-section">
      <!-- Contact/Email Button - c87a233 -->
      <ContactFormPopup client:idle triggerType="icon" triggerClassName="sticky-contact-popup" />

      <!-- Account Icon - fb697af - view-framed -->
      <div class="sticky-user-session">
        <UserSession client:idle type="account" />
      </div>

      <!-- Wishlist Icon - 80c9398 - view-framed -->
      <div class="sticky-wishlist-wrapper">
        <WishlistCount client:idle />
      </div>

      <!-- Cart Icon - 0ab1fd6 - view-framed -->
      <div class="sticky-user-session sticky-cart-session">
        <UserSession client:idle type="cart" />
      </div>
    </div>
  </div>
</header>

<style>
  /* Sticky Header - matching WordPress d92208c */
  /* Mobile-first: hidden by default, shown on desktop */
  .sticky-header {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: #FFFFFF;
    z-index: 1000;
    box-shadow: 0px 9px 10px 0px rgba(0, 0, 0, 0.05);
    transform: translateY(-100%);
    transition: transform 0.3s ease;
    font-family: 'Jost', sans-serif;
  }

  .sticky-header.visible {
    transform: translateY(0);
  }

  /* Explicit mobile hiding for safety */
  @media (max-width: 768px) {
    .sticky-header {
      display: none !important;
    }
  }

  @media (min-width: 769px) {
    .sticky-header {
      display: block;
    }
  }

  .sticky-header-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 10px 0;
    display: flex;
    align-items: center;
    position: relative; /* for dropdown positioning */
  }

  /* Sections with exact WordPress widths from media queries */
  .sticky-section {
    display: flex;
  }

  /* 190f56f - 25% width */
  .sticky-menu-section {
    width: 25%;
    padding: 0;
  }

  /* 234bc1b - 50% width - search */
  .sticky-search-section {
    width: 50%;
    justify-content: space-evenly;
    align-items: stretch;
    background: #FFFFFF;
    padding: 0;
  }

  /* Search input styling */
  .sticky-search-section :global(.product-search-input) {
    border: 1px solid #253461;
    font-size: 16px;
  }

  .sticky-search-section :global(.product-search-input::placeholder) {
    color: #253461;
  }

  /* df3bc94 - 25% width - icons */
  .sticky-icons-section {
    width: 25%;
    flex-direction: row;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
  }

  /* Menu wrapper */
  .sticky-menu-wrapper {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  /* Hamburger Button - matching WordPress 16px border-radius */
  .elementor-menu-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #253461;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    color: #FFFFFF;
    width: 48px;
    height: 48px;
    padding: 0;
    flex-shrink: 0;
  }

  .elementor-menu-toggle svg {
    width: 24px;
    height: 24px;
    fill: #FFFFFF;
  }

  /* ALLE KATEGORIEN button - matching WordPress b71ac43 */
  .all-categories-text {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: none;
    border: none;
    padding: 0;
    font-family: 'Jost', sans-serif;
    font-size: 15px;
    font-weight: 500;
    color: #253461;
    text-transform: uppercase;
    white-space: nowrap;
    cursor: pointer;
    transition: color 0.3s;
  }

  .all-categories-text:hover {
    color: #00AEEF;
  }

  /* Triangle indicator next to ALLE KATEGORIEN */
  .category-triangle {
    transition: transform 0.3s ease;
    flex-shrink: 0;
  }

  .sticky-menu-wrapper:has(.sticky-dropdown-nav.active) .category-triangle {
    transform: rotate(180deg);
  }

  .elementor-menu-toggle .menu-icon-close {
    display: none;
  }

  .elementor-menu-toggle.active .menu-icon-open {
    display: none;
  }

  .elementor-menu-toggle.active .menu-icon-close {
    display: block;
  }

  /* Dropdown Navigation - Column layout with logo header */
  .sticky-dropdown-nav {
    position: absolute;
    top: 100%;
    left: 0;
    background: #FFFFFF;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    border-radius: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 100;
    display: flex;
    flex-direction: column;
    min-height: 500px;
  }

  .sticky-dropdown-nav.active {
    opacity: 1;
    visibility: visible;
  }

  /* Logo header - full width at top */
  .dropdown-logo-header {
    padding: 25px;
    border-bottom: 1px solid #E5E7EB;
  }

  .dropdown-logo {
    height: 55px;
    width: auto;
  }

  /* Content area - two columns below logo */
  .dropdown-content {
    display: flex;
    flex-direction: row;
    flex: 1;
  }

  /* Left Column: Main Menu */
  .dropdown-left-column {
    width: 240px;
    min-width: 240px;
    border-right: 1px solid #E5E7EB;
    display: flex;
    flex-direction: column;
  }

  /* Right Column: Submenu Title + Items */
  .dropdown-right-column {
    flex: 1;
    min-width: 500px;
    display: flex;
    flex-direction: column;
  }

  /* Submenu title wrapper - no border */
  .submenu-title-wrapper {
    padding: 20px 25px;
  }

  .submenu-title {
    font-family: 'Jost', sans-serif;
    font-size: 22px;
    font-weight: 600;
    color: #253461;
    text-transform: uppercase;
  }

  /* Submenu container */
  .dropdown-submenu-container {
    flex: 1;
    padding: 0 25px 25px 25px;
  }

  /* Main menu list - vertical on left */
  .sticky-nav-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0;
    flex: 1;
  }

  .sticky-nav-item {
    position: static;
  }

  .sticky-nav-link {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    height: 65px; /* even more spacing */
    padding: 22px 25px; /* increased vertical padding */
    background: transparent;
    border: none;
    border-bottom: 1px solid #F0F0F0;
    font-family: 'Jost', sans-serif;
    font-size: 18px; /* bigger font size */
    font-weight: 600;
    color: #253461; /* --e-global-color-secondary */
    cursor: pointer;
    text-align: left;
    transition: color 0.3s, background-color 0.3s;
    text-transform: uppercase;
    box-sizing: border-box;
  }

  .sticky-nav-link:hover {
    color: #00AEEF; /* --n-menu-title-color-hover */
    background-color: #F5F5F5; /* light gray hover */
  }

  .sticky-nav-item.active .sticky-nav-link {
    color: #00AEEF; /* --n-menu-title-color-active */
    background-color: #F5F5F5;
  }

  .submenu-arrow {
    width: 16px; /* --n-menu-icon-size */
    height: 16px;
    transition: transform 0.2s;
    margin-left: 8px;
  }

  /* Submenu - Grid layout in right column */
  .sticky-submenu {
    display: none;
    list-style: none;
    margin: 0;
    padding: 0;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(5, auto);
    grid-auto-flow: column;
    row-gap: 0;
    column-gap: 0;
  }

  .sticky-submenu.active {
    display: grid;
  }

  .sticky-submenu li a {
    display: flex;
    align-items: center;
    gap: 15px;
    height: 55px; /* bigger spacing */
    padding: 0 25px;
    color: #253461;
    text-decoration: none;
    font-family: 'Jost', sans-serif;
    font-size: 17px; /* bigger font */
    font-weight: 500;
    transition: color 0.3s;
    white-space: nowrap;
    box-sizing: border-box;
  }

  .sticky-submenu li a:hover {
    color: #469ADC;
    background-color: #F5F5F5; /* light gray hover */
  }

  .sticky-submenu li a img {
    width: 28px; /* even larger icons */
    height: 28px;
    object-fit: contain;
  }

  /* Sticky header contact popup trigger - matching original green button */
  .sticky-contact-popup:global(.contact-trigger-icon),
  :global(.sticky-contact-popup.contact-trigger-icon) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: #10C99E;
    font-family: 'Jost', sans-serif;
    font-size: 22px;
    font-weight: 500;
    text-transform: uppercase;
    border: 1px solid #10C99E;
    border-radius: 15px;
    padding: 11px;
    color: #FFFFFF;
    text-decoration: none;
    transition: all 0.3s;
    flex-shrink: 0;
    cursor: pointer;
  }

  .sticky-contact-popup:global(.contact-trigger-icon:hover),
  :global(.sticky-contact-popup.contact-trigger-icon:hover),
  .sticky-contact-popup:global(.contact-trigger-icon:focus),
  :global(.sticky-contact-popup.contact-trigger-icon:focus) {
    background-color: #FFFFFF;
    color: #10C99E;
    border-color: #10C99E;
  }

  :global(.sticky-contact-popup.contact-trigger-icon svg) {
    width: 22px;
    height: 22px;
    fill: currentColor;
  }

  :global(.sticky-contact-popup.contact-trigger-icon:hover svg),
  :global(.sticky-contact-popup.contact-trigger-icon:focus svg) {
    fill: #10C99E;
  }

  /* Icon Buttons - rounded square matching WordPress */
  .sticky-icon {
    display: inline-flex;
    text-decoration: none;
  }

  .sticky-icon .elementor-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #253461;
    border-radius: 15px;
    padding: 8px;
    color: #253461;
    background-color: transparent;
    transition: all 0.3s;
  }

  .sticky-icon .elementor-icon svg {
    width: 22px;
    height: 22px;
  }

  .sticky-icon .elementor-icon svg path {
    fill: #253461;
    transition: fill 0.3s;
  }

  .sticky-icon:hover .elementor-icon,
  .sticky-icon:focus .elementor-icon {
    color: #469ADC;
    border-color: #469ADC;
  }

  .sticky-icon:hover .elementor-icon svg path,
  .sticky-icon:focus .elementor-icon svg path {
    fill: #469ADC;
  }

  /* UserSession wrapper in sticky header */
  .sticky-user-session {
    display: flex;
    align-items: center;
  }

  /* Style the UserSession account button in sticky header */
  .sticky-user-session :global(.header-icon) {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: 1px solid #253461;
    border-radius: 15px;
    color: #253461;
    background: transparent;
    transition: all 0.3s;
    position: relative;
  }

  .sticky-user-session :global(.header-icon:hover) {
    border-color: #469ADC;
  }

  .sticky-user-session :global(.header-icon:hover svg path) {
    fill: #469ADC;
  }

  .sticky-user-session :global(.header-icon svg) {
    width: 22px;
    height: 22px;
  }

  /* Green logged-in indicator dot */
  .sticky-user-session :global(.logged-in-indicator) {
    position: absolute;
    top: -3px;
    right: -3px;
    width: 10px;
    height: 10px;
    background: #10C99E;
    border-radius: 50%;
    border: 2px solid white;
  }

  /* Cart count badge in sticky header */
  .sticky-cart-session :global(.cart-count-badge) {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #10C99E;
    color: white;
    font-size: 11px;
    font-weight: 600;
    font-family: 'Jost', sans-serif;
    min-width: 18px;
    height: 18px;
    border-radius: 9px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 4px;
    line-height: 1;
  }
</style>

<script>
  // Scroll behavior - show sticky header after scrolling past main header
  let lastScrollY = 0;
  let ticking = false;
  const stickyHeader = document.getElementById('sticky-header');
  const mainHeader = document.getElementById('main-header');
  // Cache header height once to avoid forced reflows on every scroll
  const mainHeaderHeight = mainHeader?.offsetHeight || 150;

  function updateStickyHeader() {
    const scrollY = window.scrollY;

    // Show sticky header when scrolled past main header
    if (scrollY > mainHeaderHeight + 50) {
      stickyHeader?.classList.add('visible');
    } else {
      stickyHeader?.classList.remove('visible');
    }

    lastScrollY = scrollY;
    ticking = false;
  }

  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(updateStickyHeader);
      ticking = true;
    }
  });

  // Hamburger menu toggle - scoped to sticky header only
  const menuToggle = document.getElementById('sticky-menu-toggle');
  const dropdownNav = document.getElementById('sticky-dropdown-nav');
  const navItems = dropdownNav?.querySelectorAll('.sticky-nav-item.has-submenu') || [];

  // Get all submenus in the right column - scoped to sticky dropdown
  const submenus = dropdownNav?.querySelectorAll('.sticky-submenu') || [];
  const submenuTitle = dropdownNav?.querySelector('.submenu-title-wrapper .submenu-title');

  // Submenu titles mapping
  const submenuTitles: Record<string, string> = {
    'sportarten': 'SPORTARTEN',
    'produkte': 'PRODUKTE',
    'themen': 'THEMEN'
  };

  // Function to show a specific submenu
  function showSubmenu(submenuId: string | null) {
    // Hide all submenus
    submenus.forEach(sub => sub.classList.remove('active'));
    // Show the target submenu and update title
    if (submenuId && dropdownNav) {
      // Use querySelector scoped to dropdownNav instead of global getElementById
      const targetSubmenu = dropdownNav.querySelector(`#submenu-${submenuId}`);
      targetSubmenu?.classList.add('active');
      // Update the title
      if (submenuTitle) {
        submenuTitle.textContent = submenuTitles[submenuId] || 'MENU';
      }
    }
  }

  // Function to toggle dropdown menu
  function toggleDropdownMenu() {
    const isActive = menuToggle?.classList.toggle('active');
    dropdownNav?.classList.toggle('active');
    menuToggle?.setAttribute('aria-expanded', (isActive || false).toString());
    dropdownNav?.setAttribute('aria-hidden', (!isActive).toString());

    // Show first submenu by default when menu opens
    if (isActive && navItems.length > 0) {
      navItems[0].classList.add('active');
      const firstButton = navItems[0].querySelector('.sticky-nav-link');
      firstButton?.setAttribute('aria-expanded', 'true');
      // Show first submenu
      const firstSubmenuId = navItems[0].getAttribute('data-submenu');
      showSubmenu(firstSubmenuId);
    } else {
      // Remove all active states when closing
      navItems.forEach(item => {
        item.classList.remove('active');
        const button = item.querySelector('.sticky-nav-link');
        button?.setAttribute('aria-expanded', 'false');
      });
      // Hide all submenus
      showSubmenu(null);
    }
  }

  // Hamburger menu toggle
  menuToggle?.addEventListener('click', toggleDropdownMenu);

  // ALLE KATEGORIEN text also toggles dropdown
  const allCategoriesToggle = document.getElementById('all-categories-toggle');
  allCategoriesToggle?.addEventListener('click', toggleDropdownMenu);

  // Submenu hover behavior - show submenu on hover
  navItems.forEach(item => {
    item.addEventListener('mouseenter', () => {
      // Remove active from all nav items
      navItems.forEach(i => {
        i.classList.remove('active');
        const btn = i.querySelector('.sticky-nav-link');
        btn?.setAttribute('aria-expanded', 'false');
      });
      // Add active to hovered item
      item.classList.add('active');
      const button = item.querySelector('.sticky-nav-link');
      button?.setAttribute('aria-expanded', 'true');
      // Show corresponding submenu
      const submenuId = item.getAttribute('data-submenu');
      showSubmenu(submenuId);
    });
  });

  // Close menu when clicking outside
  document.addEventListener('click', (e) => {
    if (!document.querySelector('.sticky-menu-wrapper')?.contains(e.target as Node)) {
      menuToggle?.classList.remove('active');
      dropdownNav?.classList.remove('active');
      menuToggle?.setAttribute('aria-expanded', 'false');
      dropdownNav?.setAttribute('aria-hidden', 'true');
      // Remove all active states
      navItems.forEach(item => {
        item.classList.remove('active');
        const button = item.querySelector('.sticky-nav-link');
        button?.setAttribute('aria-expanded', 'false');
      });
      // Hide all submenus
      showSubmenu(null);
    }
  });
</script>
