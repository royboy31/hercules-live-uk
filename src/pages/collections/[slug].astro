---
import BaseLayout from '../../layouts/BaseLayout.astro';
import CategoryProductCard from '../../components/CategoryProductCard.astro';
import TrustLogos from '../../components/TrustLogos.astro';
import CustomerReviews from '../../components/CustomerReviews.astro';
import {
  siteConfig,
  getCollectionPageSchema,
  getBreadcrumbSchema,
  getFAQSchema,
  truncateDescription,
  stripHtml
} from '../../config/seo';

const WORKER_URL = 'https://hercules-product-sync-uk.gilles-86d.workers.dev';

// Get the category slug from the URL
const { slug } = Astro.params;

// Fetch category details
let category = null;
try {
  const categoryRes = await fetch(`${WORKER_URL}/category/${slug}`);
  if (categoryRes.ok) {
    category = await categoryRes.json();
  }
} catch (error) {
  console.error('Error fetching category:', error);
}

// If category not found, return 404
if (!category) {
  return Astro.redirect('/404');
}

// Fetch products for this category using optimized endpoint (single API call)
let validProducts: any[] = [];
try {
  const productsRes = await fetch(`${WORKER_URL}/products-by-category/${slug}`);
  if (productsRes.ok) {
    const products = await productsRes.json();
    // Filter products with images and sort by category position
    validProducts = products
      .filter((p: any) => p && p.images?.length > 0)
      .sort((a: any, b: any) => {
        const posA = a.category_positions?.[category.id] ?? a.menu_order ?? 999;
        const posB = b.category_positions?.[category.id] ?? b.menu_order ?? 999;
        return posA - posB;
      });
  }
} catch (error) {
  console.error('Error fetching category products:', error);
}

// Fetch related products (products NOT in this category) for "Andere Kunden mochten" section
let relatedProducts: any[] = [];
try {
  const allProductsRes = await fetch(`${WORKER_URL}/products`);
  if (allProductsRes.ok) {
    const allProducts = await allProductsRes.json();
    // Filter products that are NOT in current category
    const otherProducts = allProducts.filter((p: any) =>
      !p.categories?.includes(slug)
    );
    // Shuffle and take 5 random products
    const shuffled = otherProducts.sort(() => Math.random() - 0.5);
    relatedProducts = shuffled.slice(0, 5);
  }
} catch (error) {
  console.error('Error fetching related products:', error);
}

// Generate static paths for all categories
export async function getStaticPaths() {
  const WORKER_URL = 'https://hercules-product-sync-uk.gilles-86d.workers.dev';

  try {
    const res = await fetch(`${WORKER_URL}/categories`);
    if (!res.ok) return [];

    const categories = await res.json();
    return categories.map((cat: any) => ({
      params: { slug: cat.slug }
    }));
  } catch (error) {
    console.error('Error generating static paths:', error);
    return [];
  }
}

// Generate SEO meta description
const categoryDescription = category?.description
  ? truncateDescription(stripHtml(category.description))
  : `Entdecken Sie unsere ${category?.name || 'Produkte'} Kollektion bei Hercules Merchandise. Personalisierte Sportbekleidung und Fanartikel made in Europe.`;

// Generate canonical URL
const canonicalUrl = `${siteConfig.siteUrl}/collections/${slug}/`;

// Get category image for OG
const categoryImage = category?.image
  ? `${WORKER_URL}/category-image/${slug}`
  : `${siteConfig.siteUrl}${siteConfig.defaultImage}`;

// Generate JSON-LD schemas
const jsonLdSchemas = [];

// CollectionPage schema
jsonLdSchemas.push(getCollectionPageSchema({
  name: category?.name || 'Kollektion',
  description: categoryDescription,
  url: canonicalUrl,
  image: categoryImage
}));

// Breadcrumb schema
jsonLdSchemas.push(getBreadcrumbSchema([
  { name: 'Home', url: siteConfig.siteUrl },
  { name: category?.name || 'Kollektion', url: canonicalUrl }
]));

// FAQ schema (if category has FAQ data)
const faqSchema = getFAQSchema(category?.faq);
if (faqSchema) {
  jsonLdSchemas.push(faqSchema);
}

// Get LCP image URL for preloading (must match the actual src used in CategoryProductCard)
// Note: No resize params as Cloudflare Image Resizing requires Pro plan
const lcpImageUrl = validProducts.length > 0
  ? `${WORKER_URL}/image/${validProducts[0].slug}`
  : null;
const preloadImages = lcpImageUrl ? [lcpImageUrl] : [];
---

<BaseLayout
  title={category.name}
  description={categoryDescription}
  pageType="collection"
  ogImage={categoryImage}
  jsonLd={jsonLdSchemas}
  preloadImages={preloadImages}
>
  <section class="category-page">
    <div class="category-container">
      <!-- Breadcrumb -->
      <nav class="breadcrumb" aria-label="Breadcrumb">
        <ol itemscope itemtype="https://schema.org/BreadcrumbList">
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="/" itemprop="item">
              <span itemprop="name">Home</span>
            </a>
            <meta itemprop="position" content="1" />
            <span class="separator"><img src="/images/breadcrumb-separator.svg" alt="" width="6" height="12" /></span>
          </li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name">{category.name}</span>
            <meta itemprop="position" content="2" />
          </li>
        </ol>
      </nav>

      <!-- Category Header -->
      <header class="category-header">
        <h1 class="category-title">{category.name}</h1>
        {category.description && (
          <div class="category-description" set:html={category.description} />
        )}
        {category.second_description && (
          <a href="#read-more-desc" class="weiterlesen-link">Weiterlesen</a>
        )}
      </header>

      <!-- Product Grid -->
      {validProducts.length > 0 ? (
        <ul class="products">
          {validProducts.map((product: any, index: number) => (
            <CategoryProductCard product={product} index={index} />
          ))}
        </ul>
      ) : (
        <div class="no-products">
          <p>Keine Produkte in dieser Kategorie gefunden.</p>
        </div>
      )}

      <!-- Read More Description (SEO Content) -->
      {category.second_description && (
        <section class="read-more-section" id="read-more-desc">
          <div class="second-description" set:html={category.second_description} />
        </section>
      )}

    </div>

    <!-- FAQ Section - Full width white background -->
    {category.faq && category.faq.length > 0 && (
      <section id="faq" class="faq-section">
        <div class="container">
          <div class="faq-card">
            <div class="faq-header">
              <!-- Stacked layers icon from WordPress -->
              <svg class="faq-title-icon" xmlns="http://www.w3.org/2000/svg" width="40" height="44" viewBox="0 0 40 44" fill="none">
                <path d="M39.7673 30.6429C39.9704 31.0031 40.0256 31.4308 39.9207 31.8325C39.8159 32.2342 39.5597 32.577 39.208 32.786L20.7572 43.786C20.5221 43.9262 20.2548 44 19.9826 44C19.7105 44 19.4432 43.9262 19.2081 43.786L0.757253 32.786C0.410712 32.5731 0.160134 32.2294 0.0597732 31.8291C-0.0405878 31.4288 0.0173444 31.0043 0.221027 30.6473C0.424709 30.2904 0.75775 30.0298 1.14804 29.922C1.53834 29.8142 1.95447 29.8678 2.30636 30.0713L19.9884 40.6098L37.6705 30.0713C38.0229 29.8638 38.4414 29.8074 38.8344 29.9145C39.2274 30.0216 39.5629 30.2836 39.7673 30.6429ZM37.6705 20.6427L19.9884 31.1811L2.30636 20.6427C1.95626 20.4645 1.5529 20.4294 1.17837 20.5445C0.803835 20.6596 0.486288 20.9162 0.290356 21.2621C0.0944252 21.608 0.0348365 22.0173 0.123719 22.4065C0.2126 22.7958 0.443273 23.1358 0.768785 23.3573L19.2196 34.3574C19.4547 34.4975 19.722 34.5714 19.9942 34.5714C20.2663 34.5714 20.5336 34.4975 20.7687 34.3574L39.2196 23.3573C39.3968 23.2549 39.5523 23.1174 39.6772 22.953C39.802 22.7886 39.8936 22.6005 39.9467 22.3996C39.9999 22.1987 40.0134 21.9891 39.9866 21.7828C39.9598 21.5765 39.8932 21.3777 39.7906 21.1979C39.688 21.0182 39.5516 20.861 39.3891 20.7356C39.2266 20.6102 39.0414 20.519 38.8441 20.4674C38.6469 20.4157 38.4416 20.4046 38.2401 20.4347C38.0386 20.4648 37.845 20.5355 37.6705 20.6427ZM0 12.5714C0.000613186 12.2961 0.0719491 12.0259 0.206868 11.7877C0.341788 11.5495 0.535558 11.3516 0.768785 11.214L19.2196 0.213952C19.4547 0.0738314 19.722 0 19.9942 0C20.2663 0 20.5336 0.0738314 20.7687 0.213952L39.2196 11.214C39.4517 11.3524 39.6442 11.5506 39.7781 11.7887C39.9119 12.0269 39.9823 12.2967 39.9823 12.5714C39.9823 12.846 39.9119 13.1158 39.7781 13.354C39.6442 13.5921 39.4517 13.7903 39.2196 13.9287L20.7687 24.9288C20.5336 25.0689 20.2663 25.1427 19.9942 25.1427C19.722 25.1427 19.4547 25.0689 19.2196 24.9288L0.768785 13.9287C0.535558 13.7911 0.341788 13.5933 0.206868 13.3551C0.0719491 13.1168 0.000613186 12.8466 0 12.5714ZM4.58965 12.5714L19.9884 21.7525L35.3872 12.5714L19.9884 3.39022L4.58965 12.5714Z" fill="#253461"/>
              </svg>
              <h2 class="faq-title">Häufig gestellte <span class="highlight">Fragen</span></h2>
            </div>
            <div class="faq-accordion">
              {category.faq.map((item: { question: string; answer: string }, index: number) => (
                <div class="faq-item" data-faq-index={index}>
                  <button class="faq-question" aria-expanded="false">
                    <span>{item.question}</span>
                    <!-- Plus icon (collapsed state) -->
                    <svg class="faq-icon faq-icon-plus" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
                      <path d="M15.7143 14.2857H20.7143C21.1088 14.2857 21.4286 14.6055 21.4286 15C21.4286 15.3945 21.1088 15.7143 20.7143 15.7143H15.7143V20.7143C15.7143 21.1088 15.3945 21.4286 15 21.4286C14.6055 21.4286 14.2857 21.1088 14.2857 20.7143V15.7143H9.28571C8.89123 15.7143 8.57143 15.3945 8.57143 15C8.57143 14.6055 8.89123 14.2857 9.28571 14.2857H14.2857V9.28571C14.2857 8.89123 14.6055 8.57143 15 8.57143C15.3945 8.57143 15.7143 8.89123 15.7143 9.28571V14.2857ZM15 30C6.71573 30 0 23.2843 0 15C0 6.71573 6.71573 0 15 0C23.2843 0 30 6.71573 30 15C30 23.2843 23.2843 30 15 30ZM15 28.5714C22.4953 28.5714 28.5714 22.4953 28.5714 15C28.5714 7.50471 22.4953 1.42857 15 1.42857C7.50471 1.42857 1.42857 7.50471 1.42857 15C1.42857 22.4953 7.50471 28.5714 15 28.5714Z" fill="#469ADC"/>
                    </svg>
                    <!-- Minus icon (expanded state) -->
                    <svg class="faq-icon faq-icon-minus" xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" fill="none">
                      <path d="M20.7143 14.2857C21.1088 14.2857 21.4286 14.6055 21.4286 15C21.4286 15.3945 21.1088 15.7143 20.7143 15.7143H9.28571C8.89123 15.7143 8.57143 15.3945 8.57143 15C8.57143 14.6055 8.89123 14.2857 9.28571 14.2857H20.7143ZM15 30C6.71573 30 0 23.2843 0 15C0 6.71573 6.71573 0 15 0C23.2843 0 30 6.71573 30 15C30 23.2843 23.2843 30 15 30ZM15 28.5714C22.4953 28.5714 28.5714 22.4953 28.5714 15C28.5714 7.50471 22.4953 1.42857 15 1.42857C7.50471 1.42857 1.42857 7.50471 1.42857 15C1.42857 22.4953 7.50471 28.5714 15 28.5714Z" fill="#469ADC"/>
                    </svg>
                  </button>
                  <div class="faq-answer">
                    <div class="faq-answer-content" set:html={item.answer}></div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </section>
    )}

    <!-- Related Products Section - "Andere Kunden mochten diese Produkte ebenfalls" -->
    {relatedProducts.length > 0 && (
      <section class="related-products-section">
        <div class="related-products-container">
          <h2 class="related-heading">
            Andere Kunden mochten <span class="highlight">diese Produkte ebenfalls</span>
          </h2>
          <ul class="related-products">
            {relatedProducts.map((product: any) => (
              <li class="related-product-item">
                <a href={`/products/${product.slug}`} class="related-product-link">
                  <img
                    src={`https://hercules-product-sync-uk.gilles-86d.workers.dev/image/${product.slug}/0`}
                    alt={product.name}
                    loading="lazy"
                    width="1000"
                    height="1000"
                  />
                  <h2 class="related-product-title">{product.name}</h2>
                </a>
              </li>
            ))}
          </ul>
        </div>
      </section>
    )}
  </section>

  <!-- Trust Logos Section - "Sie vertrauen uns" -->
  <TrustLogos />

  <!-- Customer Reviews Section - "Was Kunden über uns sagen" -->
  <CustomerReviews />
</BaseLayout>

<style>
  .category-page {
    width: 100%;
    padding: 0 0 0 0;
    background: #FAFAFA;
    overflow-x: hidden;
  }

  .category-container {
    width: 100%;
    max-width: 1280px;
    margin: 0 auto;
    padding: 0;
    box-sizing: border-box;
  }

  /* Breadcrumb */
  .breadcrumb {
    margin: 0;
    padding-top: 20px;
  }

  .breadcrumb ol {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    list-style: none;
    margin: 0;
    padding: 0;
    font-family: 'Jost', sans-serif;
    font-size: 14px;
    font-weight: 400;
    color: #787878;
  }

  .breadcrumb li {
    display: flex;
    align-items: center;
  }

  .breadcrumb a {
    color: #787878;
    text-decoration: none;
    transition: color 0.2s;
  }

  .breadcrumb a:hover {
    color: #253461;
  }

  .breadcrumb .separator {
    display: flex;
    align-items: center;
    margin: 0 10px;
  }

  .breadcrumb .separator img {
    display: block;
    width: 6px;
    height: 12px;
    aspect-ratio: 6 / 12;
  }

  /* Current page (last item) in light blue */
  .breadcrumb li:last-child span[itemprop="name"] {
    color: #469ADC;
  }

  /* Category Header */
  .category-header {
    margin-bottom: 20px;
    text-align: center;
  }

  .category-title {
    font-family: 'Jost', 'Jost Fallback', sans-serif;
    font-size: 35px;
    font-weight: 600;
    color: #253461;
    margin: 20px 0 20px 0;
    text-transform: uppercase;
    line-height: 1.2;
    min-height: 42px; /* Reserve space to prevent CLS */
  }

  .category-description {
    font-family: 'Roboto', 'Roboto Fallback', sans-serif;
    font-size: 16px;
    font-weight: 400;
    line-height: 1.7em;
    color: #626262;
    max-width: 75%;
    margin: 0 auto;
  }

  .category-description :global(strong) {
    color: #253461;
    font-weight: 600;
  }

  /* Weiterlesen Link */
  .weiterlesen-link {
    display: inline-block;
    margin-top: 15px;
    font-family: 'Jost', sans-serif;
    font-size: 16px;
    font-weight: 500;
    color: #469ADC;
    text-decoration: none;
    text-transform: uppercase;
    transition: color 0.2s;
  }

  .weiterlesen-link:hover {
    color: #253461;
    text-decoration: underline;
  }

  /* Product Grid - 3 columns */
  .products {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin: 20px 0 40px 0;
    padding: 0;
    list-style: none;
  }

  /* No products message */
  .no-products {
    text-align: center;
    padding: 60px 20px;
    font-family: 'Roboto', sans-serif;
    font-size: 18px;
    color: #666;
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .category-container {
      padding: 0 15px;
    }

    .products {
      grid-template-columns: repeat(2, 1fr);
    }

    .category-description {
      max-width: 90%;
    }
  }

  @media (max-width: 767px) {
    .category-page {
      padding: 0;
    }

    .category-container {
      padding: 0 10px;
    }

    .products {
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }

    .category-description {
      max-width: 100%;
    }

    .category-title {
      font-size: 28px;
    }
  }

  @media (max-width: 480px) {
    .products {
      grid-template-columns: 1fr;
    }
  }

  /* Read More Description Section (SEO Content) - Matches Elementor global kit */
  .read-more-section {
    margin-top: 60px;
    padding: 40px 0;
    border-top: 1px solid #EAEAEA;
    text-align: center;
  }

  .second-description {
    font-family: 'Jost', sans-serif;
    font-size: 16px;
    font-weight: 400;
    line-height: 1.8;
    color: #5F5F5F;
    text-align: center;
    max-width: 900px;
    margin: 0 auto;
  }

  .second-description :global(h2),
  .second-description :global(h3) {
    font-family: 'Jost', sans-serif;
    font-weight: 500;
    color: #253461;
    margin-top: 30px;
    margin-bottom: 15px;
    text-align: center;
  }

  .second-description :global(h2) {
    font-size: 25px;
  }

  .second-description :global(h3) {
    font-size: 22px;
  }

  .second-description :global(p) {
    margin-bottom: 15px;
  }

  .second-description :global(strong) {
    color: #253461;
    font-weight: 600;
  }

  .second-description :global(ul),
  .second-description :global(ol) {
    margin: 15px auto;
    padding-left: 25px;
    text-align: left;
    display: inline-block;
  }

  .second-description :global(li) {
    margin-bottom: 8px;
  }

  .second-description :global(a) {
    color: #00AEEF;
    text-decoration: none;
    transition: color 0.2s;
  }

  .second-description :global(a:hover) {
    color: #253461;
    text-decoration: underline;
  }

  @media (max-width: 767px) {
    .read-more-section {
      margin-top: 40px;
      padding: 30px 0;
    }

    .second-description :global(h2) {
      font-size: 22px;
    }

    .second-description :global(h3) {
      font-size: 18px;
    }
  }

  /* Related Products Section - "Andere Kunden mochten diese Produkte ebenfalls" - Matching WordPress */
  .related-products-section {
    padding: 60px 0 0;
    background: #fafafa;
    width: 100%;
  }

  .related-products-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 0;
  }

  .related-heading {
    font-family: 'Jost', sans-serif;
    font-size: 35px;
    font-weight: 600;
    color: #253461;
    text-align: center;
    margin: 0 0 40px 0;
    text-transform: uppercase;
  }

  .related-heading .highlight {
    color: #469ADC;
  }

  /* Grid: 5 columns, 20px column gap, 40px row gap */
  .related-products {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    grid-column-gap: 20px;
    grid-row-gap: 40px;
    margin: 0;
    padding: 0 50px;
    list-style: none;
    width: 100%;
  }

  .related-product-item {
    background: #fff;
    text-align: center;
    border: 1px solid #DCDCDC;
    border-radius: 20px;
    padding: 40px 15px;
    box-sizing: border-box;
  }

  .related-product-link {
    text-decoration: none;
    display: block;
  }

  .related-product-link img {
    width: 100%;
    height: auto;
    aspect-ratio: 1;
    object-fit: contain;
    display: block;
    border-radius: 10px;
  }

  .related-product-title {
    font-family: 'Jost', sans-serif;
    font-size: 18px;
    font-weight: 500;
    color: #253461;
    margin: 15px 0 0 0;
    padding: 0;
    line-height: 1.3;
    text-align: center;
    text-transform: uppercase;
  }

  .related-product-link:hover .related-product-title {
    color: #469ADC;
  }

  /* Tablet: 4 columns */
  @media (max-width: 1024px) {
    .related-products-section {
      padding: 40px 0;
    }

    .related-products {
      grid-template-columns: repeat(4, 1fr);
      grid-column-gap: 15px;
      grid-row-gap: 30px;
    }

    .related-heading {
      font-size: 28px;
    }
  }

  /* Mobile: 2 columns */
  @media (max-width: 767px) {
    .related-products-section {
      padding: 40px 0;
    }

    .related-products {
      grid-template-columns: repeat(2, 1fr);
      grid-column-gap: 15px;
      grid-row-gap: 20px;
    }

    .related-heading {
      font-size: 22px;
      margin-bottom: 25px;
    }

    .related-product-item {
      padding: 20px 10px;
    }

    .related-product-title {
      font-size: 14px;
    }
  }

  /* Small mobile: 1 column */
  @media (max-width: 480px) {
    .related-products {
      grid-template-columns: 1fr;
    }
  }

  /* FAQ Section Styles - Card style matching product description */
  .faq-section {
    padding: 40px 0;
    background: #ffffff;
  }

  .faq-section .container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0;
  }

  .faq-card {
    background: #ffffff;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 30px;
  }

  .faq-header {
    display: flex;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e0e0e0;
    position: relative;
  }

  .faq-title-icon {
    flex-shrink: 0;
    position: absolute;
    left: 0;
  }

  .faq-title {
    font-family: 'Jost', sans-serif;
    font-size: 35px;
    font-weight: 600;
    text-transform: uppercase;
    color: #253461;
    margin: 0;
    text-align: center;
    width: 100%;
  }

  .faq-title .highlight {
    color: #469ADC;
  }

  .faq-accordion {
    width: 100%;
  }

  .faq-item {
    border-bottom: 1px solid #e0e0e0;
  }

  .faq-item:last-child {
    border-bottom: none;
  }

  .faq-question {
    width: 100%;
    padding: 18px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: none;
    border: none;
    cursor: pointer;
    text-align: left;
    font-family: 'Jost', sans-serif;
    font-size: 25px;
    font-weight: 400;
    color: #253461;
  }

  .faq-question:hover {
    color: #253461;
  }

  .faq-question span {
    flex: 1;
    padding-right: 15px;
  }

  /* Plus/Minus icon toggle */
  .faq-icon {
    flex-shrink: 0;
  }

  .faq-icon-minus {
    display: none;
  }

  .faq-item.active .faq-icon-plus {
    display: none;
  }

  .faq-item.active .faq-icon-minus {
    display: block;
  }

  .faq-answer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .faq-item.active .faq-answer {
    max-height: 500px;
  }

  .faq-answer-content {
    padding: 0 0 20px 0;
    font-family: 'Roboto', sans-serif;
    font-size: 15px;
    line-height: 1.7;
    color: #5f5f5f;
  }

  .faq-answer-content :global(p) {
    margin: 0 0 15px 0;
  }

  .faq-answer-content :global(p:last-child) {
    margin-bottom: 0;
  }

  @media (max-width: 768px) {
    .faq-section {
      padding: 30px 0;
    }

    .faq-section .container {
      padding: 0 15px;
    }

    .faq-card {
      padding: 20px;
    }

    .faq-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }

    .faq-title-icon {
      position: static;
    }

    .faq-title {
      font-size: 24px;
      text-align: left;
    }

    .faq-question {
      font-size: 15px;
      padding: 15px 0;
    }

    .faq-answer-content {
      font-size: 14px;
    }
  }
</style>

<script>
  // FAQ Accordion toggle
  const faqItems = document.querySelectorAll('.faq-item');
  faqItems.forEach(item => {
    const question = item.querySelector('.faq-question');
    if (question) {
      question.addEventListener('click', () => {
        // Close other open items
        faqItems.forEach(other => {
          if (other !== item && other.classList.contains('active')) {
            other.classList.remove('active');
            const btn = other.querySelector('.faq-question');
            if (btn) btn.setAttribute('aria-expanded', 'false');
          }
        });
        // Toggle current item
        item.classList.toggle('active');
        const isActive = item.classList.contains('active');
        question.setAttribute('aria-expanded', isActive ? 'true' : 'false');
      });
    }
  });
</script>
